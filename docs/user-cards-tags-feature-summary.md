# User Cards Tags Feature - 实现总结

## 功能概述

为用户卡片（user_cards）添加了tags功能，允许用户为自己的学习卡片添加自定义标签，支持标签的增删改查操作。

## 🛠️ 实现的功能

### 1. 数据库层面

#### 1.1 UserCard实体更新
- 在 `src/anki/entities/user-cards.entity.ts` 中添加了 `tags` 字段
- 字段类型：`VARCHAR(500) NULL`
- 用于存储用户自定义标签，支持逗号分隔的多标签格式

#### 1.2 数据库迁移
- 创建了迁移文件：`src/migrations/1734163200000-AddTagsToUserCards.ts`
- 添加 tags 列到 user_cards 表
- 支持回滚操作

### 2. API层面

#### 2.1 更新用户卡片接口增强
**接口路径**: `POST /anki/updateCard`

**新增功能**:
- 支持更新用户自定义标签
- 支持单独更新标签或与其他字段一起更新
- 保持向后兼容性

**请求参数**:
```json
{
  "id": "string",           // 必填 - 用户卡片UUID
  "custom_back": "string",  // 可选 - 自定义背面内容
  "tags": "string"          // 可选 - 用户自定义标签
}
```

#### 2.2 查询用户卡片接口增强
**接口路径**: `GET /anki/user-cards/query`

**新增功能**:
- 标签查询支持同时搜索原始卡片标签和用户自定义标签
- 返回数据区分用户标签和原始标签

**查询参数增强**:
- `tags`: 同时搜索 `card.tags` 和 `userCard.tags`

**返回数据增强**:
```json
{
  "tags": "合并的标签",      // 优先使用用户自定义标签
  "userTags": "用户标签",    // 用户自定义标签
  "originalTags": "原始标签" // 原始卡片标签
}
```

### 3. 业务逻辑层面

#### 3.1 UpdateUserCardDto 更新
- 在 `src/anki/dto/update-anki.dto.ts` 中添加了 `tags` 字段
- 字段为可选，支持灵活更新
- 添加了数据验证注解

#### 3.2 AnkiService 更新
- 更新了 `updateUserCard` 方法，支持tags字段更新
- 更新了 `queryUserCards` 方法，支持用户标签查询
- 添加了详细的日志记录

#### 3.3 QueryUserCardsDto 更新
- 更新了返回数据接口定义
- 添加了 `userTags` 和 `originalTags` 字段说明

## 📋 使用示例

### 1. 更新用户卡片标签

```http
POST /anki/updateCard
Content-Type: application/json
Authorization: Bearer your-jwt-token

{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "tags": "重要,困难,语法,动词"
}
```

### 2. 查询带有特定标签的卡片

```http
GET /anki/user-cards/query?tags=语法&page=1&limit=20
```

### 3. 查询用户自定义标签

```http
GET /anki/user-cards/query?tags=重要&sortBy=updatedAt&sortOrder=DESC
```

## 🔄 数据流程

### 标签优先级
1. **显示优先级**: 用户自定义标签 > 原始卡片标签
2. **查询范围**: 同时搜索用户标签和原始标签
3. **数据分离**: 用户标签和原始标签分别存储

### 更新流程
1. 客户端发送更新请求
2. 验证用户权限和数据格式
3. 更新用户卡片的tags字段
4. 返回更新后的完整卡片信息
5. 记录操作日志

### 查询流程
1. 构建查询条件，包含用户标签筛选
2. 使用OR条件同时搜索原始标签和用户标签
3. 返回区分标签来源的完整数据

## 🎯 功能特性

### 1. 灵活性
- ✅ 支持单独更新标签
- ✅ 支持批量更新多个字段
- ✅ 支持清空标签（传空字符串）
- ✅ 支持多标签（逗号分隔）

### 2. 兼容性
- ✅ 向后兼容原有API
- ✅ 不影响现有数据结构
- ✅ 渐进式增强功能

### 3. 查询能力
- ✅ 标签模糊查询
- ✅ 复合条件查询
- ✅ 分页和排序支持
- ✅ 数据来源区分

### 4. 数据安全
- ✅ 用户权限验证
- ✅ 数据格式验证
- ✅ 错误处理完善
- ✅ 操作日志记录

## 📚 相关文档

1. [User Cards Query API](./user-cards-query-api.md) - 查询接口详细文档
2. [Update User Card API](./update-user-card-api.md) - 更新接口详细文档

## 🚀 后续扩展建议

### 1. 标签管理优化
- 实现标签自动补全
- 添加标签使用统计
- 支持标签颜色分类

### 2. 批量操作
- 批量添加标签
- 批量移除标签
- 标签批量替换

### 3. 智能推荐
- 基于内容的标签推荐
- 基于用户行为的标签建议
- 热门标签展示

### 4. 数据分析
- 标签使用分析
- 学习效果与标签关联分析
- 个性化学习路径推荐

## ⚠️ 注意事项

1. **标签格式**: 建议使用逗号分隔多个标签，避免使用特殊字符
2. **长度限制**: 标签字段最大长度为500字符，需要在前端控制输入
3. **性能考虑**: 大量标签查询时建议添加适当的数据库索引
4. **数据备份**: 重要的用户标签数据建议定期备份

## 🔧 开发环境设置

1. 确保数据库连接正常
2. 运行迁移添加tags列：`npm run migration:run:dev`
3. 启动开发服务器：`npm run start:dev`
4. 测试API功能是否正常

---

**版本**: v1.0  
**创建时间**: 2024年12月  
**最后更新**: 2024年12月 